<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Complete your official APC Wardship Nomination Form for the 2025 Congress. Register as a councilor aspirant using our secure online form or chatbot.">
    <meta name="keywords" content="APC, Nomination Form, Councilor, Wardship, Politics, Nigeria, APC Congress 2025, Registration">
    <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqsRHyM2yS67F34fBfngJ3oC9U2GuLtUawNOh9qrYPn6WCON3BZzZA2NUS&s=10" type="image/x-icon">

    <title>APC Councilors Wardship Nomination Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7fafc; /* Lighter grey */
            background-image: linear-gradient(to bottom, #f5f7fa, #eef2f7);
        }
        .gradient-header {
            background-image: linear-gradient(to right, #004d00, #006400, #2e8b57); /* Deeper Green Gradient */
        }
        .gradient-button {
            background-image: linear-gradient(120deg, #006400, #2e8b57); /* Angled Gradient */
            transition: all 0.3s ease;
        }
        .gradient-button:hover {
            background-image: linear-gradient(120deg, #2e8b57, #006400); /* Reversed Gradient */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 100, 0, 0.3);
        }
        .card {
            background-color: #ffffff;
            border-radius: 16px; /* Larger radius */
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.07); /* Softer shadow */
            padding: 2.5rem;
        }
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3748; /* Darker gray */
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.85rem; /* Slightly more padding */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1rem;
            color: #374151; /* gray-700 */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #006400; /* APC Green */
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.2);
            outline: none;
        }
        .form-input:read-only {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            font-weight: 600;
            cursor: not-allowed;
            border-color: #16a34a; /* green-600 */
        }
        .form-select:disabled {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
        }

        .hidden { display: none; }

        /* Custom checkbox/radio styles */
        input[type="checkbox"], input[type="radio"].form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #006400;
            border-radius: 0.25rem;
            position: relative;
            cursor: pointer;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        input[type="radio"].form-radio { border-radius: 50%; }
        input[type="checkbox"]:checked, input[type="radio"].form-radio:checked {
            background-color: #006400;
            border-color: #006400;
        }
        input[type="checkbox"]:checked::after {
            content: '✓';
            color: white;
            font-size: 1rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        input[type="radio"].form-radio:checked::after {
            content: '';
            width: 0.625rem;
            height: 0.625rem;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Language Selector Styles */
        #lang-selector {
            background-color: #e5e7eb;
            border-radius: 9999px;
            padding: 0.35rem;
            display: inline-flex;
            margin-bottom: 2rem;
        }
        #lang-selector label {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 600;
            color: #4b5563;
            transition: all 0.3s ease;
        }
        #lang-selector input[type="radio"] {
            display: none;
        }
        #lang-selector input[type="radio"]:checked + label {
            background-color: #006400;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Lock Screen Overlay */
        #lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .lock-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Chat Styles */
        #chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f9fafb;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.5s ease;
            line-height: 1.6;
        }
        .chat-bot {
            background-color: #006400;
            color: white;
            margin-right: auto;
        }
        .chat-user {
            background-color: #e5e7eb;
            color: #333;
            margin-left: auto;
        }
        .chat-typing {
            background-color: #006400;
            color: white;
            margin-right: auto;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
        }
        .chat-typing::after {
            content: '...';
            animation: typing 1s steps(3, end) infinite;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .error-message {
            color: #dc2626; /* red-600 */
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 10px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #006400;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
            border-radius: 9999px;
            transition: width 0.4s ease-in-out;
            animation: progress-active 2s linear infinite;
        }
        @keyframes progress-active {
            0% { background-position: 0 0; }
            100% { background-position: 2rem 0; }
        }

        /* Switch Button */
        .switch-button {
            background-color: transparent;
            border: 1px solid #006400;
            color: #006400;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .switch-button:hover {
            background-color: #006400;
            color: white;
        }

        /* Chat Back Button */
        #chat-back {
            background-color: #d1d5db;
            color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            margin-right: 0.5rem;
            transition: background-color 0.3s ease;
        }
        #chat-back:hover {
            background-color: #b0b8c3;
        }
        #chat-back:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Chat Suggestions */
        #chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .suggestion-btn {
            background-color: #e5e7eb;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .suggestion-btn:hover {
            background-color: #d1d5db;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-10 px-4">

    <!-- LOCK SCREEN OVERLAY -->
    <div id="lock-overlay">
        <div class="lock-card">
            <svg class="mx-auto h-16 w-16 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 0 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
            </svg>
            <h2 class="mt-4 text-2xl font-bold text-gray-800" data-translate="lockTitle">Access Denied</h2>
            <p class="mt-2 text-gray-600" data-translate="lockMsg1">
                A valid nomination code is required to access this form.
            </p>
            <p class="mt-4 text-sm font-medium text-gray-700" data-translate="lockMsg2">
                Please scan the QR code on your official APC nomination card to proceed. If you have just purchased your card, please try again.
            </p>
        </div>
    </div>

    <!-- MAIN FORM CONTAINER -->
    <div id="main-form-container" class="max-w-4xl w-full hidden">
        <!-- HEADER -->
        <header class="gradient-header text-white p-8 rounded-t-xl flex flex-col md:flex-row items-center justify-between text-center md:text-left shadow-xl">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <!-- === ADDED ID 'header-logo' FOR PDF === -->
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqsRHyM2yS67F34fBfngJ3oC9U2GuLtUawNOh9qrYPn6WCON3BZzZA2NUS&s=10" alt="APC Logo" id="header-logo" class="h-20 w-20 rounded-full bg-white p-2 border-2 border-yellow-400">
                <div>
                    <h1 class="text-3xl font-bold mb-1" data-translate="formTitle">APC Wardship Nomination Form</h1>
                    <p class="text-lg font-light" data-translate="formSubtitle">Councilor Aspirant Registration</p>
                </div>
            </div>
            <div class="text-yellow-400 font-semibold text-xl" data-translate="congressTitle">
                APC Congress 2025
            </div>
        </header>

        <div class="card">
            <!-- LANGUAGE SELECTOR -->
            <div class="flex justify-center">
                <div id="lang-selector">
                    <input type="radio" id="lang-en" name="language" value="en" checked>
                    <label for="lang-en">English</label>
                    <input type="radio" id="lang-yo" name="language" value="yo">
                    <label for="lang-yo">Yorùbá</label>
                    <input type="radio" id="lang-ha" name="language" value="ha">
                    <label for="lang-ha">Hausa</label>
                    <input type="radio" id="lang-ig" name="language" value="ig">
                    <label for="lang-ig">Igbo</label>
                </div>
            </div>

            <!-- MODE SELECTOR -->
            <div id="mode-selector" class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="modeTitle">Choose Interaction Mode</h2>
                <div class="flex flex-col sm:flex-row justify-center sm:space-x-4 space-y-4 sm:space-y-0">
                    <button id="form-mode-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300" data-translate="modeForm">Normal Form</button>
                    <button id="chat-mode-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300" data-translate="modeChat">Chat with the Secretary</button>
                </div>
            </div>

            <!-- FORM SECTION -->
            <div id="form-section" class="hidden">
                <div class="text-right mb-4">
                    <button id="switch-to-chat-btn" class="switch-button" data-translate="switchToChat">Switch to Chat Mode</button>
                </div>
                <form id="nomination-form" class="space-y-8">
                    <!-- SECTION 1: PERSONAL INFORMATION -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 pb-3 border-yellow-400" data-translate="section1Title">1. Aspirant's Personal Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="first_name" class="form-label" data-translate="firstNameLabel">First Name</label>
                                <input type="text" id="first_name" name="first_name" class="form-input" data-translate-placeholder="firstNamePlaceholder" placeholder="Enter your first name" required>
                                <span id="first_name_error" class="error-message hidden" data-translate="errorFirstName">First name is required.</span>
                            </div>
                            <div>
                                <label for="middle_name" class="form-label" data-translate="middleNameLabel">Middle Name <span class="font-normal text-gray-500">(Optional)</span></label>
                                <input type="text" id="middle_name" name="middle_name" class="form-input" data-translate-placeholder="middleNamePlaceholder" placeholder="Enter your middle name">
                            </div>
                            <div>
                                <label for="last_name" class="form-label" data-translate="lastNameLabel">Last Name</label>
                                <input type="text" id="last_name" name="last_name" class="form-input" data-translate-placeholder="lastNamePlaceholder" placeholder="Enter your last name" required>
                                <span id="last_name_error" class="error-message hidden" data-translate="errorLastName">Last name is required.</span>
                            </div>
                            <div>
                                <label for="dob" class="form-label" data-translate="dobLabel">Date of Birth</label>
                                <input type="date" id="dob" name="dob" class="form-input" required max="2025-10-27">
                                <span id="dob_error" class="error-message hidden" data-translate="errorDob">Valid date of birth is required (must be in the past).</span>
                            </div>
                            <div>
                                <label for="gender" class="form-label" data-translate="genderLabel">Gender</label>
                                <select id="gender" name="gender" class="form-select" required>
                                    <option value="" data-translate="genderSelect">Select Gender</option>
                                    <option value="male" data-translate="genderMale">Male</option>
                                    <option value="female" data-translate="genderFemale">Female</option>
                                </select>
                                <span id="gender_error" class="error-message hidden" data-translate="errorGender">Gender is required.</span>
                            </div>
                            <div>
                                <label for="phone" class="form-label" data-translate="phoneLabel">Phone Number</label>
                                <input type="tel" id="phone" name="phone" class="form-input" data-translate-placeholder="phonePlaceholder" placeholder="e.g., 08012345678" required pattern="0\d{10}">
                                <span id="phone_error" class="error-message hidden" data-translate="errorPhone">Valid Nigerian phone number is required (11 digits starting with 0).</span>
                            </div>
                            <div class="md:col-span-3">
                                <label for="email" class="form-label" data-translate="emailLabel">Email Address <span class="font-normal text-gray-500">(Optional)</span></label>
                                <input type="email" id="email" name="email" class="form-input" data-translate-placeholder="emailPlaceholder" placeholder="e.g., yourname@example.com">
                                <span id="email_error" class="error-message hidden" data-translate="errorEmail">Valid email is required if provided.</span>
                            </div>
                            <div>
                                <label for="state_of_origin" class="form-label" data-translate="stateOriginLabel">State of Origin</label>
                                <select id="state_of_origin" name="state_of_origin" class="form-select" required>
                                    <option value="" data-translate="stateOriginSelect">Select State of Origin</option>
                                </select>
                                <span id="state_of_origin_error" class="error-message hidden" data-translate="errorStateOrigin">State of origin is required.</span>
                            </div>
                            <div>
                                <label for="lga_of_origin" class="form-label" data-translate="lgaOriginLabel">LGA of Origin</label>
                                <select id="lga_of_origin" name="lga_of_origin" class="form-select" required disabled>
                                    <option value="" data-translate="lgaOriginSelect">Select LGA of Origin</option>
                                </select>
                                <span id="lga_of_origin_error" class="error-message hidden" data-translate="errorLgaOrigin">LGA of origin is required.</span>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 2: CONTACT INFORMATION -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 pb-3 border-yellow-400" data-translate="section2Title">2. Contact Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="address" class="form-label" data-translate="addressLabel">Residential Address</label>
                                <input type="text" id="address" name="address" class="form-input" data-translate-placeholder="addressPlaceholder" placeholder="House number, street name" required>
                                <span id="address_error" class="error-message hidden" data-translate="errorAddress">Residential address is required.</span>
                            </div>
                            <div>
                                <label for="city" class="form-label" data-translate="cityLabel">City/Town</label>
                                <input type="text" id="city" name="city" class="form-input" data-translate-placeholder="cityPlaceholder" placeholder="e.g., Abuja" required>
                                <span id="city_error" class="error-message hidden" data-translate="errorCity">City/town is required.</span>
                            </div>
                            <div>
                                <label for="state_of_residence" class="form-label" data-translate="stateResidenceLabel">State of Residence</label>
                                <select id="state_of_residence" name="state_of_residence" class="form-select" required>
                                    <option value="" data-translate="stateResidenceSelect">Select State of Residence</option>
                                </select>
                                <span id="state_of_residence_error" class="error-message hidden" data-translate="errorStateResidence">State of residence is required.</span>
                            </div>
                            <div>
                                <label for="lga_of_residence" class="form-label" data-translate="lgaResidenceLabel">LGA of Residence</label>
                                <select id="lga_of_residence" name="lga_of_residence" class="form-select" required disabled>
                                    <option value="" data-translate="lgaResidenceSelect">Select LGA of Residence</option>
                                </select>
                                <span id="lga_of_residence_error" class="error-message hidden" data-translate="errorLgaResidence">LGA of residence is required.</span>
                            </div>
                            <div class="md:col-span-2">
                                <label for="ward" class="form-label" data-translate="wardLabel">Ward</label>
                                <input type="text" id="ward" name="ward" class="form-input" data-translate-placeholder="wardPlaceholder" placeholder="Enter your Ward name/number" required>
                                <span id="ward_error" class="error-message hidden" data-translate="errorWard">Ward is required.</span>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 3: PARTY AFFILIATION -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 pb-3 border-yellow-400" data-translate="section3Title">3. Party Affiliation</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="nomination_code" class="form-label" data-translate="nominationCodeLabel">Nomination Code (Verified)</label>
                                <input type="text" id="nomination_code" name="nomination_code" class="form-input" readonly required>
                            </div>
                            <div>
                                <label for="apc_reg_no" class="form-label" data-translate="apcRegNoLabel">APC Membership Registration Number</label>
                                <input type="text" id="apc_reg_no" name="apc_reg_no" class="form-input" data-translate-placeholder="apcRegNoPlaceholder" placeholder="Enter APC Reg. No." required>
                                <span id="apc_reg_no_error" class="error-message hidden" data-translate="errorApcRegNo">APC registration number is required.</span>
                            </div>
                            <div class="md:col-span-2">
                                <label for="apc_join_date" class="form-label" data-translate="apcJoinDateLabel">Date Joined APC</label>
                                <input type="date" id="apc_join_date" name="apc_join_date" class="form-input" required max="2025-10-27">
                                <span id="apc_join_date_error" class="error-message hidden" data-translate="errorApcJoinDate">Valid join date is required (must be in the past).</span>
                            </div>
                            <div class="md:col-span-2">
                                <label class="form-label" data-translate="heldPositionLabel">Have you held any party position before?</label>
                                <div class="flex items-center space-x-6 mt-2">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="held_position" value="yes" id="pos_yes" class="form-radio">
                                        <span class="text-gray-700" data-translate="yes">Yes</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="held_position" value="no" id="pos_no" class="form-radio" checked>
                                        <span class="text-gray-700" data-translate="no">No</span>
                                    </label>
                                </div>
                                <span id="held_position_error" class="error-message hidden" data-translate="errorHeldPosition">This field is required.</span>
                            </div>
                            <div id="previous_position_section" class="md:col-span-2 hidden">
                                <label for="previous_position" class="form-label" data-translate="prevPositionLabel">If Yes, please state the position(s) and year(s)</label>
                                <textarea id="previous_position" name="previous_position" rows="3" class="form-textarea" data-translate-placeholder="prevPositionPlaceholder" placeholder="e.g., Ward Secretary (2018-2020)"></textarea>
                                <span id="previous_position_error" class="error-message hidden" data-translate="errorPrevPosition">This field is required if yes.</span>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 4: ACADEMIC QUALIFICATIONS -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 pb-3 border-yellow-400" data-translate="section4Title">4. Academic Qualifications</h2>
                        <p class="text-gray-600 mb-4" data-translate="section4Desc">Please list your academic qualifications, starting from the highest.</p>
                        <div id="qualifications_container" class="space-y-4">
                            <div class="qualification-entry grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div class="md:col-span-2">
                                    <label for="qualification_1_degree" class="form-label" data-translate="degreeLabel">Degree/Certificate</label>
                                    <input type="text" id="qualification_1_degree" name="qualification_degree" class="form-input" data-translate-placeholder="degreePlaceholder" placeholder="e.g., B.Sc. Political Science" required>
                                    <span id="qualification_1_degree_error" class="error-message hidden" data-translate="errorDegree">Degree is required.</span>
                                </div>
                                <div>
                                    <label for="qualification_1_institution" class="form-label" data-translate="institutionLabel">Institution</label>
                                    <input type="text" id="qualification_1_institution" name="qualification_institution" class="form-input" data-translate-placeholder="institutionPlaceholder" placeholder="e.g., University of Lagos" required>
                                    <span id="qualification_1_institution_error" class="error-message hidden" data-translate="errorInstitution">Institution is required.</span>
                                </div>
                                <div>
                                    <label for="qualification_1_year" class="form-label" data-translate="yearLabel">Year Obtained</label>
                                    <input type="number" id="qualification_1_year" name="qualification_year" class="form-input" data-translate-placeholder="yearPlaceholder" placeholder="e.g., 2010" required min="1950" max="2025">
                                    <span id="qualification_1_year_error" class="error-message hidden" data-translate="errorYear">Year between 1950 and 2025 is required.</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add_qualification" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white apc-green hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-apc-green transition-colors" style="background-color: #006400;" data-translate="addQualificationBtn">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add Another Qualification
                        </button>
                    </section>

                    <!-- SECTION 5: DECLARATION -->
                    <section class="animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 pb-3 border-yellow-400" data-translate="section5Title">5. Declaration</h2>
                        <div class="flex items-start mb-6">
                            <label for="declaration" class="flex items-start cursor-pointer">
                                <input type="checkbox" id="declaration" name="declaration" class="mt-1" required>
                                <span class="ml-3 text-gray-700 text-base leading-relaxed" data-translate="declarationText">
                                    I solemnly declare that all information provided in this nomination form is true and correct to the best of my knowledge and belief. I understand that any false information may lead to disqualification.
                                </span>
                            </label>
                        </div>
                        <span id="declaration_error" class="error-message hidden" data-translate="errorDeclaration">You must agree to the declaration.</span>
                    </section>

                    <!-- SUBMIT BUTTON -->
                    <div class="text-center pt-4">
                        <button type="submit" class="gradient-button text-white font-bold py-3 px-10 rounded-full text-lg shadow-xl hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-green-300 focus:ring-opacity-75 transition-all duration-300" data-translate="submitFormBtn">
                            Submit Nomination Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- CHAT SECTION -->
            <div id="chat-section" class="hidden">
                <div class="text-right mb-4">
                    <button id="switch-to-form-btn" class="switch-button" data-translate="switchToForm">Switch to Form Mode</button>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div id="chat-progress-bar" class="progress-bar"></div>
                </div>

                <div id="chat-messages" class="space-y-4 mb-4"></div>
                
                <div class="flex">
                    <button id="chat-back" data-translate="chatBackBtn">Back</button>
                    <input id="chat-input" type="text" class="form-input flex-1" data-translate-placeholder="chatPlaceholder" placeholder="Type your response...">
                    <button id="chat-send" class="gradient-button text-white font-bold py-2 px-6 ml-2 rounded-md shadow-md hover:shadow-xl transition-all duration-300" data-translate="chatSendBtn">Send</button>
                </div>
                <div id="chat-suggestions" class="flex flex-wrap gap-2 mt-3"></div>

                <div id="chat-submit-section" class="text-center pt-4 hidden">
                    <button id="chat-submit" class="gradient-button text-white font-bold py-3 px-10 rounded-full text-lg shadow-xl hover:shadow-2xl transition-all duration-300" data-translate="chatSubmitBtn">
                        Submit Nomination
                    </button>
                </div>
            </div>

            <!-- SUCCESS SECTION -->
            <div id="success-section" class="hidden text-center">
                <h2 class="text-2xl font-bold text-green-600 mb-6 animate__animated animate__bounceIn" data-translate="successTitle">Submission Successful!</h2>
                <div class="flex flex-col sm:flex-row justify-center sm:space-x-4 space-y-4 sm:space-y-0">
                    <button id="download-form-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300" data-translate="downloadFormBtn">Download Filled Form</button>
                    <button id="download-receipt-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300" data-translate="downloadReceiptBtn">Download Receipt</button>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer class="mt-8 text-center text-gray-600 text-sm">
            <p data-translate="footer1">&copy; 2025 All Progressives Congress (APC). All Rights Reserved.</p>
            <p data-translate="footer2">Powered by APC Directorate of Digital Operations.</p>
        </footer>
    </div>

    <!-- JAVASCRIPT SECTION -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { jsPDF } = window.jspdf;

            // --- TRANSLATIONS OBJECT ---
            // Helper to create full translations from English
            function createFullTranslations(base, overrides) {
                const en = translations['en'];
                const fullLang = { ...en }; // Start by cloning English
                for (const key in overrides) {
                    if (Object.prototype.hasOwnProperty.call(overrides, key)) {
                        fullLang[key] = overrides[key];
                    }
                }
                return fullLang;
            }

            let translations = {
                'en': {
                    'lockTitle': 'Access Denied',
                    'lockMsg1': 'A valid nomination code is required to access this form.',
                    'lockMsg2': 'Please scan the QR code on your official APC nomination card to proceed. If you have just purchased your card, please try again.',
                    'formTitle': 'APC Wardship Nomination Form',
                    'formSubtitle': 'Councilor Aspirant Registration',
                    'congressTitle': 'APC Congress 2025',
                    'modeTitle': 'Choose Interaction Mode',
                    'modeForm': 'Normal Form',
                    'modeChat': 'Chat with the Secretary',
                    'switchToChat': 'Switch to Chat Mode',
                    'switchToForm': 'Switch to Form Mode',
                    'chatBackBtn': 'Back',
                    'section1Title': "1. Aspirant's Personal Information",
                    'firstNameLabel': 'First Name',
                    'firstNamePlaceholder': 'Enter your first name',
                    'middleNameLabel': 'Middle Name',
                    'middleNamePlaceholder': 'Enter your middle name',
                    'lastNameLabel': 'Last Name',
                    'lastNamePlaceholder': 'Enter your last name',
                    'dobLabel': 'Date of Birth',
                    'genderLabel': 'Gender',
                    'genderSelect': 'Select Gender',
                    'genderMale': 'Male',
                    'genderFemale': 'Female',
                    'phoneLabel': 'Phone Number',
                    'phonePlaceholder': 'e.g., 08012345678',
                    'emailLabel': 'Email Address',
                    'emailPlaceholder': 'e.g., yourname@example.com',
                    'stateOriginLabel': 'State of Origin',
                    'stateOriginSelect': 'Select State of Origin',
                    'lgaOriginLabel': 'LGA of Origin',
                    'lgaOriginSelect': 'Select LGA of Origin',
                    'section2Title': '2. Contact Information',
                    'addressLabel': 'Residential Address',
                    'addressPlaceholder': 'House number, street name',
                    'cityLabel': 'City/Town',
                    'cityPlaceholder': 'e.g., Abuja',
                    'stateResidenceLabel': 'State of Residence',
                    'stateResidenceSelect': 'Select State of Residence',
                    'lgaResidenceLabel': 'LGA of Residence',
                    'lgaResidenceSelect': 'Select LGA of Residence',
                    'wardLabel': 'Ward',
                    'wardPlaceholder': 'Enter your Ward name/number',
                    'section3Title': '3. Party Affiliation',
                    'nominationCodeLabel': 'Nomination Code (Verified)',
                    'apcRegNoLabel': 'APC Membership Registration Number',
                    'apcRegNoPlaceholder': 'Enter APC Reg. No.',
                    'apcJoinDateLabel': 'Date Joined APC',
                    'heldPositionLabel': 'Have you held any party position before?',
                    'yes': 'Yes',
                    'no': 'No',
                    'prevPositionLabel': 'If Yes, please state the position(s) and year(s)',
                    'prevPositionPlaceholder': 'e.g., Ward Secretary (2018-2020)',
                    'section4Title': '4. Academic Qualifications',
                    'section4Desc': 'Please list your academic qualifications, starting from the highest.',
                    'degreeLabel': 'Degree/Certificate',
                    'degreePlaceholder': 'e.g., B.Sc. Political Science',
                    'institutionLabel': 'Institution',
                    'institutionPlaceholder': 'e.g., University of Lagos',
                    'yearLabel': 'Year Obtained',
                    'yearPlaceholder': 'e.g., 2010',
                    'addQualificationBtn': 'Add Another Qualification',
                    'section5Title': '5. Declaration',
                    'declarationText': 'I solemnly declare that all information provided in this nomination form is true and correct to the best of my knowledge and belief. I understand that any false information may lead to disqualification.',
                    'submitFormBtn': 'Submit Nomination Form',
                    'chatPlaceholder': 'Type your response...',
                    'chatSendBtn': 'Send',
                    'chatSubmitBtn': 'Submit Nomination',
                    'successTitle': 'Submission Successful!',
                    'downloadFormBtn': 'Download Filled Form',
                    'downloadReceiptBtn': 'Download Receipt',
                    'footer1': '© 2025 All Progressives Congress (APC). All Rights Reserved.',
                    'footer2': 'Powered by APC Directorate of Digital Operations.',
                    'errorFirstName': 'First name is required.',
                    'errorLastName': 'Last name is required.',
                    'errorDob': 'Valid date of birth is required (must be in the past).',
                    'errorGender': 'Gender is required.',
                    'errorPhone': 'Valid Nigerian phone number is required (11 digits starting with 0).',
                    'errorEmail': 'Valid email is required if provided.',
                    'errorStateOrigin': 'State of origin is required.',
                    'errorLgaOrigin': 'LGA of origin is required.',
                    'errorAddress': 'Residential address is required.',
                    'errorCity': 'City/town is required.',
                    'errorStateResidence': 'State of residence is required.',
                    'errorLgaResidence': 'LGA of residence is required.',
                    'errorWard': 'Ward is required.',
                    'errorApcRegNo': 'APC registration number is required.',
                    'errorApcJoinDate': 'Valid join date is required (must be in the past).',
                    'errorHeldPosition': 'This field is required.',
                    'errorPrevPosition': 'This field is required if yes.',
                    'errorDegree': 'Degree is required.',
                    'errorInstitution': 'Institution is required.',
                    'errorYear': 'Year between 1950 and 2025 is required.',
                    'errorDeclaration': 'You must agree to the declaration.',
                    'chatWelcome': 'Welcome to the APC Nomination Chat with the Secretary! I\'ll ask questions one by one.',
                    'chatCodeVerified': 'Your nomination code is verified: ',
                    'chatTyping': 'Secretary is typing',
                    'chatQuestionFirstName': 'What is your first name?',
                    'chatErrorFirstName': 'First name is required.',
                    'chatQuestionMiddleName': 'What is your middle name? (optional, press enter to skip)',
                    'chatQuestionLastName': 'What is your last name?',
                    'chatErrorLastName': 'Last name is required.',
                    'chatQuestionDob': 'What is your date of birth? (Format: YYYY-MM-DD)',
                    'chatErrorDob': 'Invalid date format or date must be in the past (YYYY-MM-DD).',
                    'chatQuestionGender': 'What is your gender?',
                    'chatErrorGender': 'Please select "Male" or "Female".',
                    'chatQuestionPhone': 'What is your phone number? (e.g., 08012345678)',
                    'chatErrorPhone': 'Invalid Nigerian phone number (11 digits starting with 0).',
                    'chatQuestionEmail': 'What is your email address? (optional, press enter to skip)',
                    'chatErrorEmail': 'Invalid email format.',
                    'chatQuestionStateOrigin': 'What is your state of origin? (e.g., Lagos, Kano, Rivers)',
                    'chatErrorStateOrigin': 'Invalid state name. Please check the spelling.',
                    'chatQuestionLgaOrigin': 'What is your LGA of origin?',
                    'chatErrorLgaOrigin': 'Invalid LGA for the selected state.',
                    'chatQuestionAddress': 'What is your residential address?',
                    'chatErrorAddress': 'Address is required.',
                    'chatQuestionCity': 'What is your city/town?',
                    'chatErrorCity': 'City/town is required.',
                    'chatQuestionStateResidence': 'What is your state of residence? (e.g., Lagos, Kano, Rivers)',
                    'chatErrorStateResidence': 'Invalid state name. Please check the spelling.',
                    'chatQuestionLgaResidence': 'What is your LGA of residence?',
                    'chatErrorLgaResidence': 'Invalid LGA for the selected state.',
                    'chatQuestionWard': 'What is your ward?',
                    'chatErrorWard': 'Ward is required.',
                    'chatQuestionApcRegNo': 'What is your APC membership registration number?',
                    'chatErrorApcRegNo': 'APC registration number is required.',
                    'chatQuestionApcJoinDate': 'What is the date you joined APC? (Format: YYYY-MM-DD)',
                    'chatErrorApcJoinDate': 'Invalid date format or date must be in the past (YYYY-MM-DD).',
                    'chatQuestionHeldPosition': 'Have you held any party position before?',
                    'chatErrorHeldPosition': 'Please select "Yes" or "No".',
                    'chatQuestionPrevPosition': 'Please state the position(s) and year(s). (e.g., Ward Secretary (2018-2020))',
                    'chatErrorPrevPosition': 'Previous position details are required.',
                    'chatStartQual': "Now, let's add your academic qualifications. Starting with the highest.",
                    'chatQuestionDegree': 'What is your degree/certificate? (e.g., B.Sc. Political Science)',
                    'chatErrorDegree': 'Degree is required.',
                    'chatQuestionInstitution': 'What is the institution? (e.g., University of Lagos)',
                    'chatErrorInstitution': 'Institution is required.',
                    'chatQuestionYear': 'What is the year obtained? (e.g., 2010)',
                    'chatErrorYear': 'Valid year between 1950 and 2025 is required.',
                    'chatQuestionMoreQual': 'Do you want to add another qualification?',
                    'chatErrorMoreQual': 'Please select "Yes" or "No".',
                    'chatQuestionDeclaration': 'I solemnly declare that all information provided in this nomination form is true and correct... Do you agree?',
                    'chatErrorDeclaration': 'You must select "Yes" to agree to the declaration.',
                    'chatComplete': 'All questions answered! Click "Submit Nomination" below.',
                    'selectLga': 'Select LGA',
                    'pdfTitle': 'APC Wardship Nomination Form',
                    'pdfCode': 'Nomination Code:',
                    'pdfSection1': 'Personal Information', // Removed numbers
                    'pdfFullName': 'Full Name:',
                    'pdfDob': 'Date of Birth:',
                    'pdfGender': 'Gender:',
                    'pdfPhone': 'Phone:',
                    'pdfEmail': 'Email:',
                    'pdfStateOrigin': 'State of Origin:',
                    'pdfLgaOrigin': 'LGA of Origin:',
                    'pdfSection2': 'Contact Information',
                    'pdfAddress': 'Address:',
                    'pdfCity': 'City/Town:',
                    'pdfStateResidence': 'State of Residence:',
                    'pdfLgaResidence': 'LGA of Residence:',
                    'pdfWard': 'Ward:',
                    'pdfSection3': 'Party Affiliation',
                    'pdfApcRegNo': 'APC Reg No:',
                    'pdfJoinDate': 'Date Joined:',
                    'pdfHeldPosition': 'Held Position:',
                    'pdfPrevPosition': 'Previous Positions:',
                    'pdfSection4': 'Academic Qualifications',
                    'pdfDegree': 'Degree:',
                    'pdfInstitution': 'Institution:',
                    'pdfYear': 'Year:',
                    'pdfSection5': 'Declaration',
                    'pdfDeclaration': 'I agree to the declaration:',
                    'pdfNotApplicable': 'N/A',
                    'receiptTitle': 'APC Nomination Receipt',
                    'receiptDate': 'Submission Date:',
                    'receiptThankYou': 'Thank you for your nomination!',
                    'receiptOfficial': 'This is your official receipt for the 2025 APC Congress.',
                    'receiptAspirant': 'Aspirant Details',
                    'receiptVerified': 'VERIFIED'
                }
            };
            
            // Create other languages based on English
            translations['yo'] = createFullTranslations('en', {
                'formTitle': 'Fọọmu Yiyan Oludije fun Igbimọ Ward APC',
                'formSubtitle': 'Ìforúkọsílẹ Oludije fun Kánsílọ',
                'modeTitle': 'Yan Ipo Ibaraṣepọ',
                'modeForm': 'Fọọmu Deede',
                'modeChat': 'Bá Akọ̀wé Sọ̀rọ̀',
                'switchToChat': 'Yipada sí Ipo Ibaraẹnisọrọ',
                'switchToForm': 'Yipada sí Ipo Fọọmu',
                'chatBackBtn': 'Padà',
                'firstNameLabel': 'Orúkọ Kìíní',
                'firstNamePlaceholder': 'Kọ orúkọ kìíní rẹ',
                'middleNameLabel': 'Orúkọ Àárín',
                'middleNamePlaceholder': 'Kọ orúkọ àárín rẹ',
                'lastNameLabel': 'Orúkọ Ìkẹyìn',
                'lastNamePlaceholder': 'Kọ orúkọ ìkẹyìn rẹ',
                'errorFirstName': 'Ó pọn dandan kí o kọ orúkọ kìíní rẹ.',
                'errorLastName': 'Ó pọn dandan kí o kọ orúkọ ìkẹyìn rẹ.',
                'chatQuestionFirstName': 'Kí ni orúkọ kìíní rẹ?',
                'chatErrorFirstName': 'Ó pọn dandan kí o kọ orúkọ kìíní rẹ.',
                'chatQuestionMiddleName': 'Kí ni orúkọ àárín rẹ? (kò pọn dandan, tẹ enter láti fò ó)',
                'chatQuestionLastName': 'Kí ni orúkọ ìkẹyìn rẹ?',
                'chatErrorLastName': 'Ó pọn dandan kí o kọ orúkọ ìkẹyìn rẹ.',
                'genderLabel': 'Takọ-Tabo',
                'genderSelect': 'Yan Takọ-Tabo',
                'genderMale': 'Okùnrin',
                'genderFemale': 'Obìnrin',
                'yes': 'Bẹ́ẹ̀ni',
                'no': 'Rárá',
                'chatQuestionGender': 'Takọ-tabo wo ni ìwọ?',
                'chatErrorGender': 'Jọ̀wọ́ yan "Okùnrin" tàbí "Obìnrin".',
                'chatQuestionHeldPosition': 'Ǹjẹ́ o ti di ipò kankan nínú ẹgbẹ́ rí?',
                'chatErrorHeldPosition': 'Jọ̀wọ́ yan "Bẹ́ẹ̀ni" tàbí "Rárá".',
            });
            translations['ha'] = createFullTranslations('en', {
                'formTitle': 'Fom ɗin Neman Takarar Kansila na Ward na APC',
                'formSubtitle': 'Rijistar Masu Neman Takarar Kansila',
                'modeTitle': 'Zaɓi Yanayin Hulɗa',
                'modeForm': 'Fom na Al\'ada',
                'modeChat': 'Yi Hira da Sakatare',
                'switchToChat': 'Canja zuwa Yanayin Hira',
                'switchToForm': 'Canja zuwa Yanayin Fom',
                'chatBackBtn': 'Baya',
                'firstNameLabel': 'Sunan Farko',
                'firstNamePlaceholder': 'Shigar da sunan farko',
                'middleNameLabel': 'Sunan Tsakiya',
                'middleNamePlaceholder': 'Shigar da sunan tsakiya',
                'lastNameLabel': 'Sunan Ƙarshe',
                'lastNamePlaceholder': 'Shigar da sunan ƙarshe',
                'errorFirstName': 'Ana buƙatar sunan farko.',
                'errorLastName': 'Ana buƙatar sunan ƙarshe.',
                'chatQuestionFirstName': 'Menene sunanka na farko?',
                'chatErrorFirstName': 'Ana buƙatar sunan farko.',
                'chatQuestionMiddleName': 'Menene sunanka na tsakiya? (na zaɓi, danna enter don tsallakewa)',
                'chatQuestionLastName': 'Menene sunanka na ƙarshe?',
                'chatErrorLastName': 'Ana buƙatar sunan ƙarshe.',
                'genderLabel': 'Jinsi',
                'genderSelect': 'Zaɓi Jinsi',
                'genderMale': 'Namiji',
                'genderFemale': 'Mace',
                'yes': 'I',
                'no': 'A\'a',
                'chatQuestionGender': 'Mene ne jinsinka?',
                'chatErrorGender': 'Da fatan za a zaɓi "Namiji" ko "Mace".',
                'chatQuestionHeldPosition': 'Shin ka taɓa riƙe wani matsayi na jam\'iyya a baya?',
                'chatErrorHeldPosition': 'Da fatan za a zaɓi "I" ko "A\'a".',
            });
            translations['ig'] = createFullTranslations('en', {
                'formTitle': 'Fọọmụ Ntinye aha APC Wardship',
                'formSubtitle': 'Ndebanye aha onye na-achọ ọkwa kansụl',
                'modeTitle': 'Họrọ Ụdị Mmekọrịta',
                'modeForm': 'Fọọmụ Nkịtị',
                'modeChat': 'Soro odeakwụkwọ kparịta ụka',
                'switchToChat': 'Gbanwee gaa na Ọnọdụ Nkata',
                'switchToForm': 'Gbanwee gaa na Ọnọdụ Fọọmụ',
                'chatBackBtn': 'Azụ',
                'firstNameLabel': 'Aha Mbụ',
                'firstNamePlaceholder': 'Tinye aha mbụ gị',
                'middleNameLabel': 'Aha Etiti',
                'middleNamePlaceholder': 'Tinye aha etiti gị',
                'lastNameLabel': 'Aha Ikpeazụ',
                'lastNamePlaceholder': 'Tinye aha ikpeazụ gị',
                'errorFirstName': 'A chọrọ aha mbụ.',
                'errorLastName': 'A chọrọ aha ikpeazụ.',
                'chatQuestionFirstName': 'Gịnị bụ aha mbụ gị?',
                'chatErrorFirstName': 'A chọrọ aha mbụ.',
                'chatQuestionMiddleName': 'Gịnị bụ aha etiti gị? (nhọrọ, pịa enter ka ịwụfee)',
                'chatQuestionLastName': 'Gịnị bụ aha ikpeazụ gị?',
                'chatErrorLastName': 'A chọrọ aha ikpeazụ.',
                'genderLabel': 'Okike',
                'genderSelect': 'Họrọ Okike',
                'genderMale': 'Nwoke',
                'genderFemale': 'Nwaanyị',
                'yes': 'Ee',
                'no': 'Mba',
                'chatQuestionGender': 'Gịnị bụ okike gị?',
                'chatErrorGender': 'Biko họrọ "Nwoke" ma ọ bụ "Nwaanyị".',
                'chatQuestionHeldPosition': 'Ị nwetụla ọkwa ọ bụla n\'ime pati mbụ?',
                'chatErrorHeldPosition': 'Biko họrọ "Ee" ma ọ bụ "Mba".',
            });

            let currentLang = 'en';
            let chatQuestions = [];
            let chatHasStarted = false;

            // --- UI Elements ---
            const modeSelector = document.getElementById('mode-selector');
            const formSection = document.getElementById('form-section');
            const chatSection = document.getElementById('chat-section');
            const successSection = document.getElementById('success-section');
            const formModeBtn = document.getElementById('form-mode-btn');
            const chatModeBtn = document.getElementById('chat-mode-btn');
            const switchToChatBtn = document.getElementById('switch-to-chat-btn');
            const switchToFormBtn = document.getElementById('switch-to-form-btn');
            const chatProgressBar = document.getElementById('chat-progress-bar');
            
            // Chat UI
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatBackBtn = document.getElementById('chat-back');
            const chatSuggestions = document.getElementById('chat-suggestions');
            const chatSubmitSection = document.getElementById('chat-submit-section');
            const chatSubmit = document.getElementById('chat-submit');

            // --- LANGUAGE SELECTOR LOGIC ---
            document.querySelectorAll('input[name="language"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
            });

            function setLanguage(lang) {
                if (!translations[lang]) return;
                currentLang = lang;
                document.documentElement.lang = lang; // Set html lang attribute

                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.getAttribute('data-translate');
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-translate-placeholder');
                    if (translations[lang][key]) {
                        el.setAttribute('placeholder', translations[lang][key]);
                    }
                });
                document.querySelectorAll('.form-select').forEach(select => {
                    const firstOption = select.querySelector('option[value=""]');
                    if (firstOption) {
                        let key;
                        if (select.id === 'gender') key = 'genderSelect';
                        else if (select.id === 'state_of_origin') key = 'stateOriginSelect';
                        else if (select.id === 'lga_of_origin') key = 'lgaOriginSelect';
                        else if (select.id === 'state_of_residence') key = 'stateResidenceSelect';
                        else if (select.id === 'lga_of_residence') key = 'lgaResidenceSelect';
                        
                        if (key && translations[lang][key]) {
                            firstOption.textContent = translations[lang][key];
                        }
                    }
                });
                
                // Ensure LGA selects are updated
                const lgaOriginPlaceholder = translations[currentLang]['lgaOriginSelect'] || 'Select LGA of Origin';
                const lgaOriginFirstOption = lgaOfOriginSelect.querySelector('option[value=""]');
                if(lgaOriginFirstOption) lgaOriginFirstOption.textContent = lgaOriginPlaceholder;

                const lgaResidencePlaceholder = translations[currentLang]['lgaResidenceSelect'] || 'Select LGA of Residence';
                const lgaResidenceFirstOption = lgaOfResidenceSelect.querySelector('option[value=""]');
                if(lgaResidenceFirstOption) lgaResidenceFirstOption.textContent = lgaResidencePlaceholder;

                populateStates();
                // Re-build chat questions with new language
                buildChatQuestions(); 

                // If chat is active, refresh it
                if (chatSection.classList.contains('hidden') === false && chatHasStarted) {
                    chatMessages.innerHTML = '';
                    addMessage(translations[currentLang]['chatWelcome']);
                    addMessage(translations[currentLang]['chatCodeVerified'] + formData.nomination_code);
                    syncChatState(); // Re-find the current question index
                    askNextQuestion(); // Ask it in the new language
                }
            }

            // --- ROBUST QR CODE VERIFICATION LOGIC ---
            const lockOverlay = document.getElementById('lock-overlay');
            const mainFormContainer = document.getElementById('main-form-container');
            const nominationCodeInput = document.getElementById('nomination_code');

            function getParamInsensitive(name) {
                const usp = new URLSearchParams(window.location.search);
                for (const [k, v] of usp.entries()) {
                    if (k.toLowerCase() === name.toLowerCase()) return v;
                }
                if (window.location.hash && window.location.hash.includes('=')) {
                    const hash = window.location.hash.replace(/^#/, '');
                    const hashParams = new URLSearchParams(hash);
                    for (const [k, v] of hashParams.entries()) {
                        if (k.toLowerCase() === name.toLowerCase()) return v;
                    }
                }
                return null;
            }

            let nominationCode = getParamInsensitive('code');
            if (nominationCode) {
                try { nominationCode = decodeURIComponent(nominationCode); } catch (_) {}
            }

            const hasCode = typeof nominationCode === 'string' && nominationCode.trim().length > 0;
            if (nominationCodeInput) {
                nominationCodeInput.value = hasCode ? nominationCode.trim() : '';
            }

            function showForm() {
                lockOverlay?.classList.add('hidden');
                mainFormContainer?.classList.remove('hidden');
                if (lockOverlay) lockOverlay.style.display = 'none';
                if (mainFormContainer) mainFormContainer.style.display = 'block';
            }
            function showLock() {
                lockOverlay?.classList.remove('hidden');
                mainFormContainer?.classList.add('hidden');
                if (lockOverlay) lockOverlay.style.display = 'flex';
                if (mainFormContainer) mainFormContainer.style.display = 'none';
            }

            if (hasCode) { showForm(); } else { showLock(); }

            setTimeout(() => {
                const showingForm = mainFormContainer && getComputedStyle(mainFormContainer).display !== 'none';
                if (hasCode && !showingForm) {
                    showForm();
                }
            }, 50);
            // --- END ROBUST QR CODE VERIFICATION LOGIC ---

            // --- NIGERIA STATES & LGAs LOGIC ---
            const stateOfOriginSelect = document.getElementById('state_of_origin');
            const lgaOfOriginSelect = document.getElementById('lga_of_origin');
            const stateOfResidenceSelect = document.getElementById('state_of_residence');
            const lgaOfResidenceSelect = document.getElementById('lga_of_residence');

            let nigeriaData = [];
            const jsonUrl = 'https://gist.githubusercontent.com/devhammed/0bb9eeac9ff22c895100d072f489dc98/raw/a7b19911407a89947c452339fee59f9335dc8225/nigeria-state-and-lgas.json';

            fetch(jsonUrl)
                .then(response => response.json())
                .then(data => {
                    nigeriaData = data;
                    populateStates();
                })
                .catch(error => {
                    console.error('Error fetching state/LGA data:', error);
                });

            function populateStates() {
                const originPlaceholder = translations[currentLang]['stateOriginSelect'] || 'Select State of Origin';
                const residencePlaceholder = translations[currentLang]['stateResidenceSelect'] || 'Select State of Residence';

                const currentOrigin = stateOfOriginSelect.value;
                const currentResidence = stateOfResidenceSelect.value;
                
                stateOfOriginSelect.innerHTML = `<option value="">${originPlaceholder}</option>`;
                stateOfResidenceSelect.innerHTML = `<option value="">${residencePlaceholder}</option>`;

                nigeriaData.forEach(state => {
                    const option1 = document.createElement('option');
                    option1.value = state.alias;
                    option1.textContent = state.state;
                    stateOfOriginSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = state.alias;
                    option2.textContent = state.state;
                    stateOfResidenceSelect.appendChild(option2);
                });

                stateOfOriginSelect.value = currentOrigin;
                stateOfResidenceSelect.value = currentResidence;
            }

            function populateLGAs(stateAlias, lgaSelect, selectedLga = '') {
                const lgaPlaceholder = (lgaSelect.id === 'lga_of_origin') 
                    ? (translations[currentLang]['lgaOriginSelect'] || 'Select LGA of Origin')
                    : (translations[currentLang]['lgaResidenceSelect'] || 'Select LGA of Residence');

                lgaSelect.innerHTML = `<option value="">${lgaPlaceholder}</option>`;
                if (!stateAlias) {
                    lgaSelect.disabled = true;
                    return;
                }
                const selectedState = nigeriaData.find(state => state.alias === stateAlias);
                if (selectedState && selectedState.lgas) {
                    selectedState.lgas.forEach(lga => {
                        const option = document.createElement('option');
                        option.value = lga;
                        option.textContent = lga;
                        lgaSelect.appendChild(option);
                    });
                    lgaSelect.disabled = false;
                    if (selectedLga) {
                        lgaSelect.value = selectedLga;
                    }
                } else {
                    lgaSelect.disabled = true;
                }
            }

            stateOfOriginSelect.addEventListener('change', () => {
                populateLGAs(stateOfOriginSelect.value, lgaOfOriginSelect);
            });

            stateOfResidenceSelect.addEventListener('change', () => {
                populateLGAs(stateOfResidenceSelect.value, lgaOfResidenceSelect);
            });
            // --- END NIGERIA STATES & LGAs LOGIC ---

            // --- PREVIOUS POSITION LOGIC ---
            const posYes = document.getElementById('pos_yes');
            const posNo = document.getElementById('pos_no');
            const previousPositionSection = document.getElementById('previous_position_section');

            function togglePreviousPosition() {
                if (posYes.checked) {
                    previousPositionSection.classList.remove('hidden');
                    previousPositionSection.querySelector('textarea').setAttribute('required', 'required');
                } else {
                    previousPositionSection.classList.add('hidden');
                    previousPositionSection.querySelector('textarea').removeAttribute('required');
                }
            }

            posYes.addEventListener('change', togglePreviousPosition);
            posNo.addEventListener('change', togglePreviousPosition);
            togglePreviousPosition();
            // --- END PREVIOUS POSITION LOGIC ---

            // --- DYNAMIC QUALIFICATIONS LOGIC ---
            const addQualificationBtn = document.getElementById('add_qualification');
            const qualificationsContainer = document.getElementById('qualifications_container');
            let qualificationCount = 1;

            addQualificationBtn.addEventListener('click', function() {
                qualificationCount++;
                const newQualificationEntry = document.createElement('div');
                newQualificationEntry.className = 'qualification-entry grid grid-cols-1 md:grid-cols-4 gap-4 items-end animate__animated animate__fadeIn';
                newQualificationEntry.innerHTML = `
                    <div class="md:col-span-2">
                        <label for="qualification_${qualificationCount}_degree" class="form-label" data-translate="degreeLabel">${translations[currentLang]['degreeLabel']}</label>
                        <input type="text" id="qualification_${qualificationCount}_degree" name="qualification_degree" class="form-input" data-translate-placeholder="degreePlaceholder" placeholder="${translations[currentLang]['degreePlaceholder']}">
                        <span id="qualification_${qualificationCount}_degree_error" class="error-message hidden" data-translate="errorDegree">${translations[currentLang]['errorDegree']}</span>
                    </div>
                    <div>
                        <label for="qualification_${qualificationCount}_institution" class="form-label" data-translate="institutionLabel">${translations[currentLang]['institutionLabel']}</label>
                        <input type="text" id="qualification_${qualificationCount}_institution" name="qualification_institution" class="form-input" data-translate-placeholder="institutionPlaceholder" placeholder="${translations[currentLang]['institutionPlaceholder']}">
                        <span id="qualification_${qualificationCount}_institution_error" class="error-message hidden" data-translate="errorInstitution">${translations[currentLang]['errorInstitution']}</span>
                    </div>
                    <div>
                        <label for="qualification_${qualificationCount}_year" class="form-label" data-translate="yearLabel">${translations[currentLang]['yearLabel']}</label>
                        <input type="number" id="qualification_${qualificationCount}_year" name="qualification_year" class="form-input" data-translate-placeholder="yearPlaceholder" placeholder="${translations[currentLang]['yearPlaceholder']}" min="1950" max="2025">
                        <span id="qualification_${qualificationCount}_year_error" class="error-message hidden" data-translate="errorYear">${translations[currentLang]['errorYear']}</span>
                    </div>
                `;
                qualificationsContainer.appendChild(newQualificationEntry);
            });
            // --- END DYNAMIC QUALIFICATIONS LOGIC ---

            // --- FORM DATA & STATE ---
            let formData = {
                nomination_code: nominationCodeInput.value,
                first_name: '',
                middle_name: '',
                last_name: '',
                dob: '',
                gender: '',
                phone: '',
                email: '',
                state_of_origin: '', // Will store alias from form, name from chat
                lga_of_origin: '',
                address: '',
                city: '',
                state_of_residence: '', // Will store alias from form, name from chat
                lga_of_residence: '',
                ward: '',
                apc_reg_no: '',
                apc_join_date: '',
                held_position: 'no',
                previous_position: '',
                qualifications: [],
                declaration: 'No'
            };

            // --- MODE SELECTION & SWITCHING LOGIC ---
            formModeBtn.addEventListener('click', () => {
                modeSelector.classList.add('hidden');
                formSection.classList.remove('hidden');
                formSection.classList.add('fade-in');
            });

            chatModeBtn.addEventListener('click', () => {
                modeSelector.classList.add('hidden');
                chatSection.classList.remove('hidden');
                chatSection.classList.add('fade-in');
                if (!chatHasStarted) {
                    startChat();
                } else {
                    // If chat started, sync form data and resume
                    switchToChatActions();
                }
            });

            function switchToChatActions() {
                // 1. Sync data from Form TO formData
                formToChat();
                
                // 2. Clear chat log and add welcome messages
                chatMessages.innerHTML = '';
                addMessage(translations[currentLang]['chatWelcome']);
                addMessage(translations[currentLang]['chatCodeVerified'] + formData.nomination_code);
                
                // 3. Find the correct state/question to resume from
                syncChatState();
                
                // 4. Ask the correct question (which also updates progress bar)
                askNextQuestion();
            }

            switchToChatBtn.addEventListener('click', switchToChatActions);

            switchToFormBtn.addEventListener('click', () => {
                // Sync data from Chat TO Form
                chatToForm();
                // Switch views
                chatSection.classList.add('hidden');
                formSection.classList.remove('hidden');
            });

            // --- FORM VALIDATION AND SUBMISSION LOGIC ---
            const nominationForm = document.getElementById('nomination-form');
            nominationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateForm()) {
                    collectFormData();
                    showSuccess();
                }
            });

            function validateForm() {
                let isValid = true;
                const today = new Date('2025-10-27');

                document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));

                function showError(id, customIndex = -1) {
                    let el;
                    if(customIndex > -1) {
                        el = document.getElementById(`qualification_${customIndex+1}_degree_error`);
                        if(el) el.classList.remove('hidden');
                        el = document.getElementById(`qualification_${customIndex+1}_institution_error`);
                        if(el) el.classList.remove('hidden');
                        el = document.getElementById(`qualification_${customIndex+1}_year_error`);
                        if(el) el.classList.remove('hidden');
                    } else {
                        el = document.getElementById(id);
                    }
                    
                    if (el) {
                        el.classList.remove('hidden');
                        isValid = false;
                    }
                }

                // Section 1
                if (!document.getElementById('first_name').value.trim()) showError('first_name_error');
                if (!document.getElementById('last_name').value.trim()) showError('last_name_error');
                const dob = document.getElementById('dob').value;
                if (!dob || new Date(dob) >= today) showError('dob_error');
                if (!document.getElementById('gender').value) showError('gender_error');
                const phoneRegex = /^0\d{10}$/;
                if (!phoneRegex.test(document.getElementById('phone').value)) showError('phone_error');
                const email = document.getElementById('email').value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (email && !emailRegex.test(email)) showError('email_error');
                if (!document.getElementById('state_of_origin').value) showError('state_of_origin_error');
                if (!document.getElementById('lga_of_origin').value) showError('lga_of_origin_error');
                // Section 2
                if (!document.getElementById('address').value.trim()) showError('address_error');
                if (!document.getElementById('city').value.trim()) showError('city_error');
                if (!document.getElementById('state_of_residence').value) showError('state_of_residence_error');
                if (!document.getElementById('lga_of_residence').value) showError('lga_of_residence_error');
                if (!document.getElementById('ward').value.trim()) showError('ward_error');
                // Section 3
                if (!document.getElementById('apc_reg_no').value.trim()) showError('apc_reg_no_error');
                const apcJoinDate = document.getElementById('apc_join_date').value;
                if (!apcJoinDate || new Date(apcJoinDate) >= today) showError('apc_join_date_error');
                const heldPosition = document.querySelector('input[name="held_position"]:checked');
                if (!heldPosition) {
                    showError('held_position_error');
                } else if (heldPosition.value === 'yes' && !document.getElementById('previous_position').value.trim()) {
                    showError('previous_position_error');
                }
                // Section 4
                document.querySelectorAll('.qualification-entry').forEach((entry, index) => {
                    const degree = entry.querySelector(`[name="qualification_degree"]`);
                    const institution = entry.querySelector(`[name="qualification_institution"]`);
                    const year = entry.querySelector(`[name="qualification_year"]`);
                    
                    if (index === 0) { // Only first is strictly required
                        if (!degree.value.trim()) showError('qualification_1_degree_error');
                        if (!institution.value.trim()) showError('qualification_1_institution_error');
                        if (!year.value || year.value < 1950 || year.value > 2025) showError('qualification_1_year_error');
                    } else { // For others, if one field is filled, others should be too
                        if (degree.value || institution.value || year.value) {
                             if (!degree.value.trim()) showError('qualification_degree_error', index);
                             if (!institution.value.trim()) showError('qualification_institution_error', index);
                             if (!year.value || year.value < 1950 || year.value > 2025) showError('qualification_year_error', index);
                        }
                    }
                });
                // Section 5
                if (!document.getElementById('declaration').checked) showError('declaration_error');

                return isValid;
            }

            function collectFormData() {
                // Section 1
                formData.first_name = document.getElementById('first_name').value.trim();
                formData.middle_name = document.getElementById('middle_name').value.trim();
                formData.last_name = document.getElementById('last_name').value.trim();
                formData.dob = document.getElementById('dob').value;
                formData.gender = document.getElementById('gender').value;
                formData.phone = document.getElementById('phone').value.trim();
                formData.email = document.getElementById('email').value.trim();
                formData.state_of_origin = document.getElementById('state_of_origin').value; // Store alias
                formData.lga_of_origin = document.getElementById('lga_of_origin').value;
                // Section 2
                formData.address = document.getElementById('address').value.trim();
                formData.city = document.getElementById('city').value.trim();
                formData.state_of_residence = document.getElementById('state_of_residence').value; // Store alias
                formData.lga_of_residence = document.getElementById('lga_of_residence').value;
                formData.ward = document.getElementById('ward').value.trim();
                // Section 3
                formData.apc_reg_no = document.getElementById('apc_reg_no').value.trim();
                formData.apc_join_date = document.getElementById('apc_join_date').value;
                formData.held_position = document.querySelector('input[name="held_position"]:checked').value;
                formData.previous_position = (formData.held_position === 'yes') ? document.getElementById('previous_position').value.trim() : '';
                // Section 4
                formData.qualifications = [];
                document.querySelectorAll('.qualification-entry').forEach(entry => {
                    const degree = entry.querySelector(`[name="qualification_degree"]`).value.trim();
                    const institution = entry.querySelector(`[name="qualification_institution"]`).value.trim();
                    const year = entry.querySelector(`[name="qualification_year"]`).value;
                    if (degree && institution && year) { // Only add if all fields are filled
                        formData.qualifications.push({ degree, institution, year });
                    }
                });
                // Section 5
                formData.declaration = document.getElementById('declaration').checked ? 'Yes' : 'No';
            }

            // --- STATE SYNC LOGIC ---
            
            function chatToForm() {
                // Section 1
                document.getElementById('first_name').value = formData.first_name || '';
                document.getElementById('middle_name').value = formData.middle_name || '';
                document.getElementById('last_name').value = formData.last_name || '';
                document.getElementById('dob').value = formData.dob || '';
                document.getElementById('gender').value = formData.gender || '';
                document.getElementById('phone').value = formData.phone || '';
                document.getElementById('email').value = formData.email || '';
                
                // Handle State/LGA selects
                // Convert state name (from chat) to alias (for form)
                const stateOriginAlias = nigeriaData.find(s => s.state.toLowerCase() === formData.state_of_origin.toLowerCase())?.alias || formData.state_of_origin;
                if (stateOriginAlias) {
                    document.getElementById('state_of_origin').value = stateOriginAlias;
                    populateLGAs(stateOriginAlias, lgaOfOriginSelect, formData.lga_of_origin);
                }
                
                // Section 2
                document.getElementById('address').value = formData.address || '';
                document.getElementById('city').value = formData.city || '';
                
                const stateResidenceAlias = nigeriaData.find(s => s.state.toLowerCase() === formData.state_of_residence.toLowerCase())?.alias || formData.state_of_residence;
                if (stateResidenceAlias) {
                    document.getElementById('state_of_residence').value = stateResidenceAlias;
                    populateLGAs(stateResidenceAlias, lgaOfResidenceSelect, formData.lga_of_residence);
                }
                
                document.getElementById('ward').value = formData.ward || '';
                
                // Section 3
                document.getElementById('apc_reg_no').value = formData.apc_reg_no || '';
                document.getElementById('apc_join_date').value = formData.apc_join_date || '';
                
                if (formData.held_position === 'yes') {
                    document.getElementById('pos_yes').checked = true;
                    document.getElementById('previous_position').value = formData.previous_position || '';
                } else {
                    document.getElementById('pos_no').checked = true;
                }
                togglePreviousPosition(); // Update visibility

                // Section 4
                // Clear all but first qualification entry
                const firstEntry = qualificationsContainer.querySelector('.qualification-entry');
                qualificationsContainer.innerHTML = ''; // Clear all
                qualificationsContainer.appendChild(firstEntry); // Add first one back
                
                // Clear fields of first entry
                firstEntry.querySelector('[name="qualification_degree"]').value = '';
                firstEntry.querySelector('[name="qualification_institution"]').value = '';
                firstEntry.querySelector('[name="qualification_year"]').value = '';
                qualificationCount = 1;


                if (formData.qualifications.length > 0) {
                    formData.qualifications.forEach((qual, index) => {
                        if (index > 0) addQualificationBtn.click(); // Add new entry for 2nd, 3rd...
                        document.getElementById(`qualification_${index+1}_degree`).value = qual.degree || '';
                        document.getElementById(`qualification_${index+1}_institution`).value = qual.institution || '';
                        document.getElementById(`qualification_${index+1}_year`).value = qual.year || '';
                    });
                }

                // Section 5
                document.getElementById('declaration').checked = (formData.declaration === 'Yes');
            }

            function formToChat() {
                // Update formData from form fields
                collectFormData();
            }

            /**
             * Finds the correct question/state to resume the chat from
             * and sets currentQuestionIndex and chatState.
             */
            function syncChatState() {
                chatState = 'base';
                
                // Find first *required* unanswered/invalid question
                for (let i = 0; i < chatQuestions.length; i++) {
                    const q = chatQuestions[i];
                    const value = formData[q.key];

                    // Skip optional fields in this check
                    if (q.key === 'middle_name' || q.key === 'email') {
                        continue;
                    }
                    
                    // Check required fields
                    if (!value || (value.trim && value.trim() === '') || !q.validate(value)) {
                        currentQuestionIndex = i; // Found first required, unanswered/invalid
                        return;
                    }
                }
                
                // All required base fields are good.
                currentQuestionIndex = chatQuestions.length;
                
                // Move to complex states
                if (formData.held_position === 'yes' && !formData.previous_position) {
                    chatState = 'prev_position';
                    return;
                }
                
                if (formData.qualifications.length === 0) {
                    chatState = 'qual_intro';
                    collectingQual = false; // Reset this flag
                    return;
                }

                if (formData.declaration !== 'Yes') {
                    chatState = 'declaration';
                    return;
                }

                // Everything is done
                chatState = 'done';
            }

            // --- CHAT LOGIC ---
            let currentQuestionIndex = 0;
            let totalChatSteps = 0;
            let chatState = 'base'; // base, prev_position, qual_degree, qual_inst, qual_year, qual_more, declaration, done
            let collectingQual = false;
            let qualTemp = { degree: '', institution: '', year: '' };
            let tempStateOrigin = '';
            let tempStateResidence = '';
            const today = new Date('2025-10-27');

            const baseChatQuestions = [
                { key: 'first_name', textKey: 'chatQuestionFirstName', validate: (res) => res.trim() !== '', errorKey: 'chatErrorFirstName' },
                { key: 'middle_name', textKey: 'chatQuestionMiddleName', validate: (res) => true, errorKey: '' }, // Optional
                { key: 'last_name', textKey: 'chatQuestionLastName', validate: (res) => res.trim() !== '', errorKey: 'chatErrorLastName' },
                { key: 'dob', textKey: 'chatQuestionDob', validate: (res) => /^\d{4}-\d{2}-\d{2}$/.test(res) && new Date(res) < today, errorKey: 'chatErrorDob' },
                { key: 'gender', textKey: 'chatQuestionGender', validate: (res) => [translations[currentLang]['genderMale'].toLowerCase(), translations[currentLang]['genderFemale'].toLowerCase(), 'male', 'female'].includes(res.toLowerCase()), errorKey: 'chatErrorGender', suggestions: ['genderMale', 'genderFemale'] },
                { key: 'phone', textKey: 'chatQuestionPhone', validate: (res) => /^0\d{10}$/.test(res.trim()), errorKey: 'chatErrorPhone' },
                { key: 'email', textKey: 'chatQuestionEmail', validate: (res) => !res.trim() || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(res.trim()), errorKey: 'chatErrorEmail' }, // Optional
                { key: 'state_of_origin', textKey: 'chatQuestionStateOrigin', validate: (res) => nigeriaData.some(state => state.state.toLowerCase() === res.toLowerCase().trim()), errorKey: 'chatErrorStateOrigin' },
                { key: 'lga_of_origin', textKey: 'chatQuestionLgaOrigin', validate: (res) => {
                    const state = nigeriaData.find(s => s.state.toLowerCase() === tempStateOrigin.toLowerCase().trim());
                    return state && state.lgas.some(lga => lga.toLowerCase() === res.toLowerCase().trim());
                }, errorKey: 'chatErrorLgaOrigin' },
                { key: 'address', textKey: 'chatQuestionAddress', validate: (res) => res.trim() !== '', errorKey: 'chatErrorAddress' },
                { key: 'city', textKey: 'chatQuestionCity', validate: (res) => res.trim() !== '', errorKey: 'chatErrorCity' },
                { key: 'state_of_residence', textKey: 'chatQuestionStateResidence', validate: (res) => nigeriaData.some(state => state.state.toLowerCase() === res.toLowerCase().trim()), errorKey: 'chatErrorStateResidence' },
                { key: 'lga_of_residence', textKey: 'chatQuestionLgaResidence', validate: (res) => {
                    const state = nigeriaData.find(s => s.state.toLowerCase() === tempStateResidence.toLowerCase().trim());
                    return state && state.lgas.some(lga => lga.toLowerCase() === res.toLowerCase().trim());
                }, errorKey: 'chatErrorLgaResidence' },
                { key: 'ward', textKey: 'chatQuestionWard', validate: (res) => res.trim() !== '', errorKey: 'chatErrorWard' },
                { key: 'apc_reg_no', textKey: 'chatQuestionApcRegNo', validate: (res) => res.trim() !== '', errorKey: 'chatErrorApcRegNo' },
                { key: 'apc_join_date', textKey: 'chatQuestionApcJoinDate', validate: (res) => /^\d{4}-\d{2}-\d{2}$/.test(res.trim()) && new Date(res) < today, errorKey: 'chatErrorApcJoinDate' },
                { key: 'held_position', textKey: 'chatQuestionHeldPosition', validate: (res) => [translations[currentLang]['yes'].toLowerCase(), translations[currentLang]['no'].toLowerCase(), 'yes', 'no'].includes(res.toLowerCase().trim()), errorKey: 'chatErrorHeldPosition', suggestions: ['yes', 'no'] }
            ];

            function buildChatQuestions() {
                chatQuestions = baseChatQuestions.map(q => ({
                    key: q.key,
                    text: translations[currentLang][q.textKey],
                    validate: q.validate,
                    error: translations[currentLang][q.errorKey],
                    suggestions: q.suggestions // Pass suggestions
                }));
                // Total steps = base questions + 3 extra steps (prev_pos, qual, declaration)
                totalChatSteps = chatQuestions.length + 3; 
            }

            function updateProgressBar() {
                let currentStep = currentQuestionIndex;
                
                if (chatState === 'prev_position') currentStep = chatQuestions.length;
                else if (chatState.startsWith('qual')) currentStep = chatQuestions.length + 1;
                else if (chatState === 'declaration') currentStep = chatQuestions.length + 2;
                else if (chatState === 'done') currentStep = totalChatSteps;

                const percent = (currentStep / totalChatSteps) * 100;
                chatProgressBar.style.width = percent + '%';
            }

            function addMessage(text, isUser = false, isError = false) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', isUser ? 'chat-user' : 'chat-bot');
                if (isError) {
                    bubble.style.backgroundColor = '#dc2626'; // red-600
                }
                bubble.textContent = text;
                chatMessages.appendChild(bubble);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addTypingIndicator() {
                const typing = document.createElement('div');
                typing.classList.add('chat-typing');
                typing.id = 'typing-indicator';
                typing.textContent = translations[currentLang]['chatTyping'] || 'Secretary is typing';
                chatMessages.appendChild(typing);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return typing;
            }

            function addSuggestion(textKey) {
                const text = translations[currentLang][textKey];
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.textContent = text;
                btn.onclick = () => {
                    chatInput.value = text;
                    chatSend.click();
                };
                chatSuggestions.appendChild(btn);
            }

            function askQuestionWithTyping(text, suggestions = []) {
                const typing = addTypingIndicator();
                setTimeout(() => {
                    if (typing.parentNode) {
                        typing.remove();
                    }
                    addMessage(text);
                    chatSuggestions.innerHTML = ''; // Clear previous
                    if (suggestions) {
                        suggestions.forEach(key => addSuggestion(key));
                    }
                }, 1000); // Shorter delay
            }

            function askNextQuestion() {
                const lang = currentLang;
                chatSuggestions.innerHTML = ''; // Clear suggestions
                
                if (chatState === 'base' && currentQuestionIndex < chatQuestions.length) {
                    chatBackBtn.disabled = (currentQuestionIndex === 0);
                    const q = chatQuestions[currentQuestionIndex];
                    askQuestionWithTyping(q.text, q.suggestions);
                } else if (chatState === 'prev_position') {
                    chatBackBtn.disabled = true; // Disable back for complex states
                    askQuestionWithTyping(translations[lang]['chatQuestionPrevPosition']);
                } else if (chatState === 'qual_intro') {
                    chatBackBtn.disabled = true;
                    askQuestionWithTyping(translations[lang]['chatStartQual']);
                    collectingQual = true;
                    chatState = 'qual_degree';
                    askQuestionWithTyping(translations[lang]['chatQuestionDegree']);
                } else if (chatState === 'qual_degree') {
                    chatBackBtn.disabled = true;
                    askQuestionWithTyping(translations[lang]['chatQuestionDegree']);
                } else if (chatState === 'qual_inst') {
                    chatBackBtn.disabled = true;
                    askQuestionWithTyping(translations[lang]['chatQuestionInstitution']);
                } else if (chatState === 'qual_year') {
                    chatBackBtn.disabled = true;
                    askQuestionWithTyping(translations[lang]['chatQuestionYear']);
                } else if (chatState === 'qual_more') {
                    chatBackBtn.disabled = true;
                    askQuestionWithTyping(translations[lang]['chatQuestionMoreQual'], ['yes', 'no']);
                }
                else if (chatState === 'declaration') {
                    chatBackBtn.disabled = true;
                    askQuestionWithTyping(translations[lang]['chatQuestionDeclaration'], ['yes']);
                } else if (chatState === 'done') {
                    chatBackBtn.disabled = true;
                    askQuestionWithTyping(translations[lang]['chatComplete']);
                    chatSubmitSection.classList.remove('hidden');
                    chatInput.disabled = true;
                    chatSend.disabled = true;
                }
                updateProgressBar();
            }

            function startChat() {
                chatHasStarted = true;
                buildChatQuestions(); // Build questions with current language
                addMessage(translations[currentLang]['chatWelcome']);
                addMessage(translations[currentLang]['chatCodeVerified'] + formData.nomination_code);
                askNextQuestion();
            }

            chatBackBtn.addEventListener('click', () => {
                if (chatState !== 'base' || currentQuestionIndex === 0) return;

                currentQuestionIndex--;
                const q = chatQuestions[currentQuestionIndex];
                
                // Remove last user answer and bot question
                const allMessages = chatMessages.querySelectorAll('.chat-bubble');
                if (allMessages.length >= 2) {
                    allMessages[allMessages.length - 1].remove(); // Bot question
                    allMessages[allMessages.length - 2].remove(); // User answer
                }

                askQuestionWithTyping(q.text, q.suggestions); // Ask previous question
                chatInput.value = formData[q.key] || '';
                chatInput.focus();
                
                chatBackBtn.disabled = (currentQuestionIndex === 0);
                updateProgressBar();
            });

            chatSend.addEventListener('click', () => {
                const response = chatInput.value.trim();
                const lang = currentLang;
                chatSuggestions.innerHTML = ''; // Clear suggestions
                
                let q;
                if (chatState === 'base' && currentQuestionIndex < chatQuestions.length) {
                    q = chatQuestions[currentQuestionIndex];
                }

                // Allow empty for optional fields
                if (q && (q.key === 'middle_name' || q.key === 'email')) {
                    if (!response) {
                        // User pressed enter to skip
                        addMessage(getLangString('pdfNotApplicable'), true); // Show "N/A"
                        formData[q.key] = ''; // Store empty string
                        currentQuestionIndex++;
                        askNextQuestion();
                        return;
                    }
                }
                
                if (!response) return; // All other fields require a response

                addMessage(response, true);
                chatInput.value = '';

                let advanced = false;

                if (chatState === 'base') {
                    if (q.validate(response)) {
                        formData[q.key] = response;
                        
                        // Standardize specific fields
                        if (q.key === 'state_of_origin') tempStateOrigin = response;
                        if (q.key === 'state_of_residence') tempStateResidence = response;
                        if (q.key === 'held_position') {
                            formData.held_position = [translations[lang]['yes'].toLowerCase(), 'yes'].includes(response.toLowerCase()) ? 'yes' : 'no';
                        }
                        if(q.key === 'gender') {
                            formData.gender = [translations[lang]['genderMale'].toLowerCase(), 'male'].includes(response.toLowerCase()) ? 'male' : 'female';
                        }
                        
                        currentQuestionIndex++;
                        advanced = true;
                    } else {
                        addMessage(q.error, false, true);
                    }
                } else if (chatState === 'prev_position') {
                    if (response.trim()) {
                        formData.previous_position = response;
                        advanced = true;
                    } else {
                        addMessage(translations[lang]['chatErrorPrevPosition'], false, true);
                    }
                } else if (chatState === 'qual_degree') {
                    if (response) {
                        qualTemp.degree = response;
                        chatState = 'qual_inst';
                        advanced = true;
                    } else {
                        addMessage(translations[lang]['chatErrorDegree'], false, true);
                    }
                } else if (chatState === 'qual_inst') {
                    if (response) {
                        qualTemp.institution = response;
                        chatState = 'qual_year';
                        advanced = true;
                    } else {
                        addMessage(translations[lang]['chatErrorInstitution'], false, true);
                    }
                } else if (chatState === 'qual_year') {
                    const yearNum = parseInt(response);
                    if (!isNaN(yearNum) && yearNum >= 1950 && yearNum <= 2025) {
                        qualTemp.year = response;
                        formData.qualifications.push({ ...qualTemp });
                        qualTemp = { degree: '', institution: '', year: '' };
                        chatState = 'qual_more';
                        advanced = true;
                    } else {
                        addMessage(translations[lang]['chatErrorYear'], false, true);
                    }
                } else if (chatState === 'qual_more') {
                    const resLower = response.toLowerCase();
                    if ([translations[lang]['yes'].toLowerCase(), 'yes'].includes(resLower)) {
                        chatState = 'qual_degree'; // Loop back
                        advanced = true;
                    } else if ([translations[lang]['no'].toLowerCase(), 'no'].includes(resLower)) {
                        collectingQual = false;
                        chatState = 'declaration'; // Move on
                        advanced = true;
                    } else {
                        addMessage(translations[lang]['chatErrorMoreQual'], false, true);
                        chatState = 'qual_more'; // Ask same question again
                        advanced = true;
                    }
                } else if (chatState === 'declaration') {
                    if ([translations[lang]['yes'].toLowerCase(), 'yes'].includes(response.toLowerCase())) {
                        formData.declaration = 'Yes';
                        chatState = 'done';
                        advanced = true;
                    } else {
                        addMessage(translations[lang]['chatErrorDeclaration'], false, true);
                    }
                }

                if (advanced) {
                    askNextQuestion();
                }
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') chatSend.click();
            });

            chatSubmit.addEventListener('click', () => {
                chatToForm(); // Final sync before success
                showSuccess();
            });

            // --- SUCCESS AND DOWNLOAD LOGIC ---
            function showSuccess() {
                formSection.classList.add('hidden');
                chatSection.classList.add('hidden');
                successSection.classList.remove('hidden');
                successSection.classList.add('fade-in');
            }

            function getLangString(key) {
                return translations[currentLang][key] || translations['en'][key];
            }
            
            function getStateName(stateValue) {
                // Check if it's an alias
                let state = nigeriaData.find(s => s.alias === stateValue);
                if (state) return state.state;
                // Check if it's already a name
                state = nigeriaData.find(s => s.state.toLowerCase() === stateValue.toLowerCase());
                if(state) return state.state;
                // Return the value if not found (e.g., if data is missing)
                return stateValue;
            }

            // === NEW PDF STYLING CONSTANTS ===
            const apcGreen = '#006400';
            const darkText = '#333333';
            const lightText = '#555555';
            const margin = 15;

            /**
             * PDF Helper: Draws the branded header
             */
            function drawHeader(doc, title) {
                const pageWidth = doc.internal.pageSize.getWidth();
                const logoImg = document.getElementById('header-logo');
                
                // Green Header Bar
                doc.setFillColor(apcGreen);
                doc.rect(0, 0, pageWidth, 35, 'F');
                
                // Add Logo
                try {
                    doc.addImage(logoImg, 'PNG', margin, 5, 25, 25);
                } catch(e) {
                    console.error("Error adding logo to PDF:", e);
                }
                
                // Add Title
                doc.setFontSize(18);
                doc.setFont('Helvetica', 'bold');
                doc.setTextColor('#FFFFFF');
                doc.text(title, margin + 30, 22);
                
                // Return Y cursor
                return 45;
            }

            /**
             * PDF Helper: Draws a styled section title
             */
            function drawSectionTitle(doc, y, title) {
                const pageWidth = doc.internal.pageSize.getWidth();
                doc.setFontSize(14);
                doc.setFont('Helvetica', 'bold');
                doc.setTextColor(apcGreen);
                doc.text(title, margin, y);
                
                doc.setDrawColor(apcGreen);
                doc.setLineWidth(0.5);
                doc.line(margin, y + 2, pageWidth - margin, y + 2);
                
                return y + 10;
            }

            /**
             * PDF Helper: Draws a key-value pair in two columns
             */
            function drawField(doc, y, label, value) {
                const pageWidth = doc.internal.pageSize.getWidth();
                const valueX = margin + 50; // X position for the value
                const valueWidth = pageWidth - margin - valueX;
                
                doc.setFontSize(10);
                doc.setFont('Helvetica', 'bold');
                doc.setTextColor(lightText);
                doc.text(label, margin, y);
                
                doc.setFont('Helvetica', 'normal');
                doc.setTextColor(darkText);
                
                const val = value || getLangString('pdfNotApplicable');
                const splitValue = doc.splitTextToSize(val, valueWidth);
                doc.text(splitValue, valueX, y);
                
                // Increment Y based on number of lines
                return y + (splitValue.length * 5) + 4;
            }
            
            /**
             * PDF Helper: Draws the footer
             */
            function drawFooter(doc) {
                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();
                
                doc.setDrawColor('#DDDDDD');
                doc.setLineWidth(0.2);
                doc.line(margin, pageHeight - 20, pageWidth - margin, pageHeight - 20);
                
                doc.setFontSize(9);
                doc.setTextColor(lightText);
                doc.text(getLangString('footer1'), pageWidth / 2, pageHeight - 15, { align: 'center' });
            }
            
            /**
             * PDF Helper: Checks for page break and adds new page
             */
            function checkPageBreak(doc, y, requiredHeight = 20) {
                const pageHeight = doc.internal.pageSize.getHeight();
                if (y > pageHeight - requiredHeight - margin) {
                    drawFooter(doc); // Add footer to current page
                    doc.addPage();
                    y = drawHeader(doc, getLangString('pdfTitle')); // Add header to new page
                }
                return y;
            }


            // === ENHANCED PDF DOWNLOAD (FORM) ===
            document.getElementById('download-form-btn').addEventListener('click', () => {
                const doc = new jsPDF();
                
                const fullName = `${formData.first_name || ''} ${formData.middle_name || ''} ${formData.last_name || ''}`.trim().replace(/\s+/g, ' ');
                const stateOriginName = getStateName(formData.state_of_origin);
                const stateResidenceName = getStateName(formData.state_of_residence);

                let y = drawHeader(doc, getLangString('pdfTitle'));

                y = checkPageBreak(doc, y, 40);
                y = drawSectionTitle(doc, y, getLangString('pdfSection1'));
                
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfFullName'), fullName);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfCode'), formData.nomination_code);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfDob'), formData.dob);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfGender'), formData.gender);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfPhone'), formData.phone);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfEmail'), formData.email);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfStateOrigin'), stateOriginName);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfLgaOrigin'), formData.lga_of_origin);
                y += 5; // Extra padding
                
                y = checkPageBreak(doc, y, 40);
                y = drawSectionTitle(doc, y, getLangString('pdfSection2'));
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfAddress'), formData.address);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfCity'), formData.city);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfStateResidence'), stateResidenceName);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfLgaResidence'), formData.lga_of_residence);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfWard'), formData.ward);
                y += 5;

                y = checkPageBreak(doc, y, 40);
                y = drawSectionTitle(doc, y, getLangString('pdfSection3'));
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfApcRegNo'), formData.apc_reg_no);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfJoinDate'), formData.apc_join_date);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfHeldPosition'), formData.held_position);
                if (formData.held_position === 'yes') {
                    y = checkPageBreak(doc, y);
                    y = drawField(doc, y, getLangString('pdfPrevPosition'), formData.previous_position);
                }
                y += 5;

                y = checkPageBreak(doc, y, 40);
                y = drawSectionTitle(doc, y, getLangString('pdfSection4'));
                if(formData.qualifications.length > 0) {
                    formData.qualifications.forEach((qual, index) => {
                        y = checkPageBreak(doc, y, 20);
                        doc.setFont('Helvetica', 'bold');
                        doc.setTextColor(darkText);
                        doc.text(`${index + 1}. ${qual.degree || getLangString('pdfNotApplicable')}`, margin, y);
                        y += 6;
                        
                        doc.setFont('Helvetica', 'normal');
                        doc.setTextColor(lightText);
                        doc.text(`${getLangString('pdfInstitution')} ${qual.institution || getLangString('pdfNotApplicable')}`, margin + 5, y);
                        y += 6;
                        doc.text(`${getLangString('pdfYear')} ${qual.year || getLangString('pdfNotApplicable')}`, margin + 5, y);
                        y += 8;
                    });
                } else {
                    y = checkPageBreak(doc, y);
                    doc.setFont('Helvetica', 'normal');
                    doc.setTextColor(darkText);
                    doc.text(getLangString('pdfNotApplicable'), margin, y);
                    y += 7;
                }
                y += 5;

                y = checkPageBreak(doc, y, 40);
                y = drawSectionTitle(doc, y, getLangString('pdfSection5'));
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfDeclaration'), formData.declaration);

                drawFooter(doc); // Add footer to the last page
                doc.save('APC_Nomination_Form.pdf');
            });

            // === ENHANCED PDF DOWNLOAD (RECEIPT) ===
            document.getElementById('download-receipt-btn').addEventListener('click', () => {
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                
                const fullName = `${formData.first_name || ''} ${formData.middle_name || ''} ${formData.last_name || ''}`.trim().replace(/\s+/g, ' ');

                let y = drawHeader(doc, getLangString('receiptTitle'));
                
                y = checkPageBreak(doc, y);

                // Add "VERIFIED" Stamp
                doc.setFillColor(apcGreen);
                doc.rect(pageWidth - margin - 50, y, 50, 10, 'F');
                doc.setTextColor('#FFFFFF');
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(10);
                doc.text(getLangString('receiptVerified'), pageWidth - margin - 25, y + 6.5, { align: 'center' });
                y += 15; // Padding after stamp
                
                doc.setFontSize(11);
                doc.setFont('Helvetica', 'normal');
                doc.setTextColor(darkText);
                doc.text(getLangString('receiptThankYou'), margin, y);
                y += 6;
                doc.text(getLangString('receiptOfficial'), margin, y);
                y += 12;

                y = checkPageBreak(doc, y, 40);
                y = drawSectionTitle(doc, y, getLangString('receiptAspirant'));
                
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfFullName'), fullName);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfCode'), formData.nomination_code);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfPhone'), formData.phone);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('pdfWard'), formData.ward);
                y = checkPageBreak(doc, y);
                y = drawField(doc, y, getLangString('receiptDate'), new Date().toLocaleDateString());

                drawFooter(doc);
                doc.save('APC_Nomination_Receipt.pdf');
            });

            // Set default language on load
            setLanguage('en');
        });
    </script>
</body>
</html>


